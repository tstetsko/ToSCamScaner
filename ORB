declare upper;

input show1m = yes;
input show5m = yes;
input show15m = yes;
input show30m = yes;
input show60m = yes;

def t = SecondsFromTime(0929); # Market open reference

# Time in minutes from open
def minFromOpen = Floor(t / 60);

# --- 1 Minute Range ---
def range1Start = 1;
def is1mReady = minFromOpen == range1Start;
def range1High = if BarNumber() < 1 then Double.NaN
                     else if is1mReady then high else range1High[1];
def range1Low  = if BarNumber() < 1 then Double.NaN 
                     else if is1mReady then low  else range1Low[1];

def range1Broken = if minFromOpen < range1Start then 0 else if (close > range1High or close < range1Low) then 1 else range1Broken[1];

def wasBroken = range1Broken[1];
def firstBreak = range1Broken and !wasBroken;
def notYetBroken = !range1Broken and !wasBroken;

def plotRangeBarsNumber = if firstBreak then minFromOpen + 1
                          else if notYetBroken then minFromOpen
                          else plotRangeBarsNumber[1];

def isVisible1 = minFromOpen >= range1Start and minFromOpen <= plotRangeBarsNumber;

plot High1 = if isVisible1 then range1High else Double.NaN;
plot Low1  =  if isVisible1 then range1Low  else Double.NaN;


High1.SetDefaultColor(Color.blaCK);
Low1.SetDefaultColor(Color.black);

High1.SetLineWeight(2);
Low1.SetLineWeight(2);